# 多维人脸分析系统项目文档

## 项目要求

**项目描述：** 
开发一个基于计算机视觉的多维人脸分析系统，通过摄像头或图片检测人脸，并分析年龄、性别、情绪和种族信息。支持实时监测和图片分析，用户可根据需求自定义检测选项。

**主要功能：**  

1. 实时监测人脸并进行分析。  
2. 选择本地图片进行人脸检测和分析。  
3. 显示检测结果，包括性别、年龄、情绪和种族。  
4. 支持用户配置检测选项。  
5. 支持图片查看功能，并可调整图片查看尺寸。

---

## 采用的技术

### 技术栈

2. **PyQt5**
   - 用于图形用户界面设计。
   - 提供窗口布局、按钮、表格、进度条等组件。
3. **OpenCV**
   - 处理和显示图像及视频流。
   - 绘制检测框。
4. **DeepFace**
   - 进行人脸分析，支持年龄、性别、情绪和种族检测。

### **库功能简介**
- **PyQt5**：提供丰富的GUI组件用于界面构建。
- **OpenCV**：图像处理库，用于摄像头画面捕获和图像格式转换。
- **DeepFace**：一个高效的人脸分析框架，提供人脸检测和多维分析功能。
- **QSettings**：保存和加载用户配置，例如图片查看尺寸和检测选项。

---

## 关键代码及相应运行结果

### **界面初始化**
**代码：**

```python
def init_ui(self):
    """初始化用户界面"""
    self.setWindowTitle("多维人脸分析系统")
    self.setFixedSize(1000, 800)
    # 图像显示区域
    self.image_label = QLabel(self)
    self.image_label.setAlignment(Qt.AlignCenter)
    self.image_label.setMinimumHeight(500)
    self.main_layout.addWidget(self.image_label, 3)
    # 功能按钮区域
    self.start_button = QPushButton("启动实时检测", self)
    self.start_button.clicked.connect(self.toggle_realtime)
    self.button_layout.addWidget(self.start_button)
```
**运行结果截图：**  
界面包含一个用于显示摄像头画面的标签，启动实时检测按钮和其他功能按钮。

---

### **实时监测功能**
**代码：**

```python
def start_realtime(self):
    """启动实时监测"""
    try:
        self.cap = cv2.VideoCapture(0)
        if not self.cap.isOpened():
            raise IOError("无法打开摄像头")
        self.timer.timeout.connect(self.update_frame)
        self.timer.start(30)
        self.realtime_running = True
        self.start_button.setText("停止实时检测")
    except Exception as e:
        QMessageBox.warning(self, "错误", f"启动实时监测失败: {str(e)}")
        self.stop_realtime()
```
**运行结果截图：**  
实时捕获并分析摄像头画面，显示带有分析结果的画面。

---

### **图片加载与分析**

**代码：**
```python
def load_image(self):
    file_path, _ = QFileDialog.getOpenFileName(self, "选择图片", "", "Image Files (*.jpg *.jpeg *.png)")
    if not file_path:
        return
    frame = cv2.imread(file_path)
    frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
    actions = [self.option_mapping[option] for option, enabled in self.detection_options.items() if enabled]
    analysis = DeepFace.analyze(img_path=file_path, actions=actions, enforce_detection=False)
    self.process_face_analysis(frame, analysis)
```
**运行结果截图：**  
用户选择一张图片后，检测结果以表格形式展示，同时在图片上绘制检测框。

---

### **检测选项配置**
**代码：**
```python
def show_detection_options(self):
    """显示检测选项配置对话框（使用中文）"""
    dialog = QDialog(self)
    layout = QVBoxLayout()
    checkboxes = {}
    for option, default in self.detection_options.items():
        checkbox = QCheckBox(option)
        checkbox.setChecked(default)
        checkboxes[option] = checkbox
        layout.addWidget(checkbox)
    save_button = QPushButton("保存设置")
    save_button.clicked.connect(lambda: self.save_options(dialog, checkboxes))
    layout.addWidget(save_button)
    dialog.setLayout(layout)
    dialog.exec_()
```
**运行结果截图：**  
弹出配置对话框，用户可选择启用或禁用年龄、性别、情绪和种族检测选项。

---

### **运行结果截图总结**
1. 主界面：包括图像显示区域和功能按钮。
2. 实时检测：动态显示摄像头捕获画面，并绘制检测框。
3. 图片检测：加载图片后，检测结果在表格中显示，图片上绘制检测框。
4. 检测选项：用户自定义检测内容。

---

### **结论**
本项目实现了一个多功能的人脸分析系统，支持实时监测和图片分析，并提供灵活的配置功能。可用于教育、商业等场景的人脸数据分析，具有广泛的实用性和可扩展性。